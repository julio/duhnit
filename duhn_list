#!/usr/bin/env python

import datetime
import argparse

import boto3
from boto3.dynamodb.conditions import Key

class DuhnList:
    def __init__(self, email, args):
        boto3.setup_default_session(profile_name='duhnit')
        dynamodb = boto3.resource('dynamodb')
        self.deeds_table = dynamodb.Table('deeds')
        self.email = email
        self.args = args

    def deed_item_formatted_date(self, done_at):
        datetime_original_format = '%Y-%m-%d %H:%M:%S.%f'
        time = datetime.datetime.strptime(done_at, datetime_original_format)

        datetime_short_format = '%Y-%m-%d %H:%M'
        return time.strftime(datetime_short_format)

    def should_filter_by_type(self):
        return self.args.type != 'all'

    def query_response(self):
        condition = Key('author-email').eq('julio@morgane.com')
        if self.should_filter_by_type():
            condition &= Key('deed-type').begins_with(self.args.type + '-')

        return self.deeds_table.query(KeyConditionExpression=condition)

    def deed_list(self):
        response = self.query_response()

        items = sorted(response['Items'], key=lambda item: item['done-at'], reverse=True)
        for item in items:
            print(self.deed_item_formatted_date(item['done-at']), item['deed-type'].split('-')[0], item['deed'])

if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Things I duhn!')

    parser.add_argument('--type', default='all', help='Things I duhn (default: all)')
    args = parser.parse_args()

    DuhnList('julio@morgane.com', args).deed_list()
